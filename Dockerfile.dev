# Development Dockerfile - Hot reload for all files
# Runs Vite dev server + Python backend

FROM node:22-bookworm-slim AS frontend-dev

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci --legacy-peer-deps

# Copy source (will be overwritten by volume mount)
COPY . .

# Expose Vite dev server port
EXPOSE 5173

# ============================================
# Backend setup
# ============================================
FROM python:3.11-slim-bookworm AS backend

WORKDIR /app/backend

# Install Python dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

COPY backend/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY backend/ ./

EXPOSE 8080

# ============================================
# Combined dev container
# ============================================
FROM node:22-bookworm-slim

# Install Python and required tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    curl \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy node_modules from frontend stage
COPY --from=frontend-dev /app/node_modules ./node_modules
COPY --from=frontend-dev /app/package*.json ./

# Copy backend
COPY backend/ ./backend/

# Install Python dependencies
RUN pip3 install --break-system-packages --no-cache-dir -r backend/requirements.txt || \
    pip3 install --no-cache-dir -r backend/requirements.txt

# Copy frontend source
COPY . .

EXPOSE 5173 8080

# Create startup script
RUN echo '#!/bin/bash\n\
# Start backend\n\
cd /app/backend && python3 -m uvicorn main:app --host 0.0.0.0 --port 8080 &\n\
\n\
# Start frontend dev server\n\
cd /app && npm run dev -- --host 0.0.0.0\n\
' > /app/start-dev.sh && chmod +x /app/start-dev.sh

CMD ["/app/start-dev.sh"]

